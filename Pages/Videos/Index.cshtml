@page
@model GrinVideoEncoder.Pages.Videos.IndexModel

@{
    ViewData["Title"] = "Videos";
}

<h1>Videos</h1>

<div class="card mb-4">
    <div class="card-header">
        <strong>Filters</strong>
    </div>
    <div class="card-body">
        <form method="get">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Filename</label>
                    <input type="text" asp-for="SearchString" class="form-control" placeholder="Search by filename..." />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Directory</label>
                    <input type="text" asp-for="DirectoryFilter" class="form-control" placeholder="Filter by directory..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Size (MB)</label>
                    <input type="number" asp-for="MinSizeMB" class="form-control" placeholder="Min" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max Size (MB)</label>
                    <input type="number" asp-for="MaxSizeMB" class="form-control" placeholder="Max" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Indexed From</label>
                    <input type="date" asp-for="DateFrom" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Indexed To</label>
                    <input type="date" asp-for="DateTo" class="form-control" />
                </div>
                <div class="col-md-6 d-flex align-items-end gap-2">
                    <input type="hidden" asp-for="SortBy" />
                    <input type="hidden" asp-for="SortDescending" />
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a asp-page="./Index" class="btn btn-outline-secondary">Clear Filters</a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="text-muted">Found <strong>@Model.TotalCount</strong> video(s)</span>
    @if (Model.TotalPages > 1)
    {
        <span class="text-muted">Page @Model.PageNumber of @Model.TotalPages</span>
    }
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>
                    <a href="@Model.GetSortUrl("Filename")" class="text-white text-decoration-none">
                        Filename @Model.GetSortIcon("Filename")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("Directory")" class="text-white text-decoration-none">
                        Directory @Model.GetSortIcon("Directory")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("Size")" class="text-white text-decoration-none">
                        Size @Model.GetSortIcon("Size")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("Duration")" class="text-white text-decoration-none">
                        Duration @Model.GetSortIcon("Duration")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("Resolution")" class="text-white text-decoration-none">
                        Resolution @Model.GetSortIcon("Resolution")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("QualityRatio")" class="text-white text-decoration-none">
                        Quality @Model.GetSortIcon("QualityRatio")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("CompressionFactor")" class="text-white text-decoration-none">
                        Compression @Model.GetSortIcon("CompressionFactor")
                    </a>
                </th>
                <th>
                    <a href="@Model.GetSortUrl("IndexedAt")" class="text-white text-decoration-none">
                        Indexed At @Model.GetSortIcon("IndexedAt")
                    </a>
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Videos)
            {
                <tr>
                    <td title="@item.Filename">
                        @if (item.Filename.Length > 50)
                        {
                            @(item.Filename[..47] + "...")
                        }
                        else
                        {
                            @item.Filename
                        }
                    </td>
                    <td title="@item.DirectoryPath">
                        @if (item.DirectoryPath.Length > 40)
                        {
                            @("..." + item.DirectoryPath[^37..])
                        }
                        else
                        {
                            @item.DirectoryPath
                        }
                    </td>
                    <td>
                        @FormatFileSize(item.FileSizeOriginal)
                    </td>
                    <td>
                        @FormatDuration(item.DurationSeconds)
                    </td>
                    <td>
                        @FormatResolution(item.Width, item.Height)
                    </td>
                    <td>
                        @FormatQualityRatio(item.QualityRatio)
                    </td>
                    <td>
                        @FormatCompressionFactor(item.CompressionFactor)
                    </td>
                    <td>
                        @item.IndexedAt.ToString("yyyy-MM-dd HH:mm")
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model.Videos.Count == 0)
{
    <div class="alert alert-info">
        No videos found matching the specified criteria.
    </div>
}

@if (Model.TotalPages > 1)
{
    <nav aria-label="Video list pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                <a class="page-link" href="?SearchString=@Model.SearchString&DirectoryFilter=@Model.DirectoryFilter&DateFrom=@Model.DateFrom?.ToString("yyyy-MM-dd")&DateTo=@Model.DateTo?.ToString("yyyy-MM-dd")&MinSizeMB=@Model.MinSizeMB&MaxSizeMB=@Model.MaxSizeMB&SortBy=@Model.SortBy&SortDescending=@Model.SortDescending&PageNumber=@(Model.PageNumber - 1)">
                    Previous
                </a>
            </li>
            @{
                var startPage = Math.Max(1, Model.PageNumber - 2);
                var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
            }
            @if (startPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" href="?SearchString=@Model.SearchString&DirectoryFilter=@Model.DirectoryFilter&DateFrom=@Model.DateFrom?.ToString("yyyy-MM-dd")&DateTo=@Model.DateTo?.ToString("yyyy-MM-dd")&MinSizeMB=@Model.MinSizeMB&MaxSizeMB=@Model.MaxSizeMB&SortBy=@Model.SortBy&SortDescending=@Model.SortDescending&PageNumber=1">1</a>
                </li>
                @if (startPage > 2)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
            }
            @for (var i = startPage; i <= endPage; i++)
            {
                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                    <a class="page-link" href="?SearchString=@Model.SearchString&DirectoryFilter=@Model.DirectoryFilter&DateFrom=@Model.DateFrom?.ToString("yyyy-MM-dd")&DateTo=@Model.DateTo?.ToString("yyyy-MM-dd")&MinSizeMB=@Model.MinSizeMB&MaxSizeMB=@Model.MaxSizeMB&SortBy=@Model.SortBy&SortDescending=@Model.SortDescending&PageNumber=@i">@i</a>
                </li>
            }
            @if (endPage < Model.TotalPages)
            {
                @if (endPage < Model.TotalPages - 1)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
                <li class="page-item">
                    <a class="page-link" href="?SearchString=@Model.SearchString&DirectoryFilter=@Model.DirectoryFilter&DateFrom=@Model.DateFrom?.ToString("yyyy-MM-dd")&DateTo=@Model.DateTo?.ToString("yyyy-MM-dd")&MinSizeMB=@Model.MinSizeMB&MaxSizeMB=@Model.MaxSizeMB&SortBy=@Model.SortBy&SortDescending=@Model.SortDescending&PageNumber=@Model.TotalPages">@Model.TotalPages</a>
                </li>
            }
            <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                <a class="page-link" href="?SearchString=@Model.SearchString&DirectoryFilter=@Model.DirectoryFilter&DateFrom=@Model.DateFrom?.ToString("yyyy-MM-dd")&DateTo=@Model.DateTo?.ToString("yyyy-MM-dd")&MinSizeMB=@Model.MinSizeMB&MaxSizeMB=@Model.MaxSizeMB&SortBy=@Model.SortBy&SortDescending=@Model.SortDescending&PageNumber=@(Model.PageNumber + 1)">
                    Next
                </a>
            </li>
        </ul>
    </nav>
}

@functions {
    string FormatFileSize(long bytes)
    {
        if (bytes >= 1073741824) // GB
            return $"{bytes / 1073741824.0:F2} GB";
        if (bytes >= 1048576) // MB
            return $"{bytes / 1048576.0:F2} MB";
        if (bytes >= 1024) // KB
            return $"{bytes / 1024.0:F2} KB";
        return $"{bytes} B";
    }

    string FormatDuration(long? durationSeconds)
    {
        if (!durationSeconds.HasValue)
            return "-";
        
        var totalSeconds = durationSeconds.Value;
        var hours = totalSeconds / 3600;
        var minutes = (totalSeconds % 3600) / 60;
        var seconds = totalSeconds % 60;
        
        if (hours >= 1)
            return $"{hours}:{minutes:D2}:{seconds:D2}";
        return $"{minutes}:{seconds:D2}";
    }

    string FormatResolution(int? width, int? height)
    {
        if (!width.HasValue || !height.HasValue)
            return "-";
        return $"{width}Ã—{height}";
    }

    string FormatQualityRatio(double? qualityRatio)
    {
        if (!qualityRatio.HasValue)
            return "-";
        return $"{qualityRatio.Value:F0}";
    }

    string FormatCompressionFactor(double? compressionFactor)
    {
        if (!compressionFactor.HasValue)
            return "-";
        return $"{compressionFactor.Value:F1}%";
    }
}
